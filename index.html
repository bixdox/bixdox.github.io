<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Audio Manipulation</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://rawgit.com/jeromeetienne/ar.js/1.7.2/aframe/build/aframe-ar.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body style="margin: 0; overflow: hidden;">
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
        <a-marker preset="hiro" id="markerHiro">
            <a-box position="0 0.5 0" material="shader: standard; color: #ffffff;"></a-box>
        </a-marker>

        <a-marker preset="kanji" id="markerKanji">
            <a-sphere position="0 0.5 0" material="color: red;"></a-sphere>
        </a-marker>

        <a-marker preset="letterA" id="markerLetterA">
            <a-sphere position="0 0.5 0" material="color: orange;"></a-sphere>
        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <div class="controls">
        <button class="sampleBox" id="startButton" onclick="startAudio()"><label>Start
                Audio</label></button>

        <div class="sampleBoxMaster">
            <p>Master Controls</p>
            <div><label for="masterVolume">Master Volume:</label>
                <input type="range" id="masterVolume" min="0" max="1" step="0.01" value="1">
                <label for="masterSpeed">Master Speed:</label>
                <input type="range" id="masterSpeed" min="0.5" max="2" step="0.1" value="1">
            </div>
        </div>
        <div class="sampleBox">
            <div class="headline">
                <div>
                    <p>Controller 01</p>
                    <p class="typeName">Harmonic Keys</p>
                </div>
                <div class="nextToEach">
                    <div class="circle-container">
                        <div id="circle1" class="circle filled"></div>
                        <div id="circle2" class="circle"></div>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" width="31" height="23" viewBox="0 0 31 23" fill="none">
                        <path
                            d="M31 0H0V20.2212C0 21.7556 1.27267 23 2.84202 23H28.1537C29.723 23 30.9957 21.7556 30.9957 20.2212V5.44836V0H31ZM18.3119 5.44836V15.004H19.7007V21.6505H11.295V15.004H12.6838V5.44836H18.3119ZM1.38016 20.2212V5.44836H8.52177V15.004H9.91484V21.6505H2.84202C2.038 21.6505 1.38016 21.0073 1.38016 20.2212ZM29.6155 20.2212C29.6155 21.0073 28.9577 21.6505 28.1537 21.6505H21.0809V15.004H22.4696V5.44836H29.6155V20.2212Z"
                            fill="#2B2B2B" />
                    </svg>
                </div>
            </div>
            <audio id="audioHiro" src="sound_1.mp3" controls preload="auto"></audio>
            <div class="inputRow">
                <div>
                    <label for="volumeHiro">Hiro Volume:</label>
                    <input type="range" id="volumeHiro" min="0" max="1" step="0.1" value="1">
                    <label for="filterHiro">Hiro Filter:</label>
                    <input type="range" id="filterHiro" min="100" max="5000" step="100" value="1000">
                </div>
                <div class="rectangleAndLoopContainer">
                    <div class="rectangle-container">
                        <div class="rectangle filled">01</div>
                        <div class="rectangle">02</div>
                        <div class="rectangle">03</div>
                        <div class="rectangle">04</div>
                    </div>
                    <div class="loopBox">
                        <label class="specialLabel">Loop:</label>
                        <label class="toggleSwitch">
                            <input type="checkbox" id="loopHiro">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="sampleBox">
            <audio id="audioKanji" src="sound_2.mp3" controls preload="auto"></audio>
            <label for="volumeKanji">Kanji Volume:</label>
            <input type="range" id="volumeKanji" min="0" max="1" step="0.1" value="1">
            <label for="filterKanji">Kanji Filter:</label>
            <input type="range" id="filterKanji" min="100" max="5000" step="100" value="1000">
            <label for="loopKanji">Loop Kanji:</label>
            <input type="checkbox" id="loopKanji">

        </div>

        <div class="sampleBox">
            <audio id="audioLetterA" src="sound_3.wav" controls preload="auto"></audio>
            <label for="volumeLetterA">LetterA Volume:</label>
            <input type="range" id="volumeLetterA" min="0" max="1" step="0.1" value="1">
            <label for="filterLetterA">LetterA Filter:</label>
            <input type="range" id="filterLetterA" min="100" max="5000" step="100" value="1000">
            <label for="loopLetterA">Loop Letter A:</label>
            <input type="checkbox" id="loopLetterA">

        </div>
    </div>
    <script>
        function updateSliderFillDark(slider) {
            const percent = 100 * (slider.value - slider.min) / (slider.max - slider.min);
            slider.style.background = `linear-gradient(to right, #AFAFAF 0%, #AFAFAF ${percent}%, #5C5C5C ${percent}%, #5C5C5C 100%)`;
        }

        document.querySelectorAll('.sampleBoxMaster input[type="range"]').forEach(slider => {
            updateSliderFillDark(slider);
            slider.addEventListener('input', () => updateSliderFillDark(slider));
        });

    </script>
    <script>
        function updateSliderFillLight(slider) {
            const percent = 100 * (slider.value - slider.min) / (slider.max - slider.min);
            slider.style.background = `linear-gradient(to right, #55524F 0%, #55524F ${percent}%, #B2B2B2 ${percent}%, #B2B2B2 100%)`;
        }

        document.querySelectorAll('.sampleBox input[type="range"]').forEach(slider => {
            updateSliderFillLight(slider);
            slider.addEventListener('input', () => updateSliderFillLight(slider));
        });
    </script>

    <script>
        function startAudio() {
            audioContext.resume().then(() => {
                document.getElementById("startButton").style.display = "none";
                console.log("Audio context started");
            });
        }
    </script>

    <script>
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let isAudioSetup = false;
        let masterGainNode;

        const audioHiro = document.getElementById("audioHiro");
        const audioKanji = document.getElementById("audioKanji");
        const audioLetterA = document.getElementById("audioLetterA");
        const volumeHiroControl = document.getElementById("volumeHiro");
        const volumeKanjiControl = document.getElementById("volumeKanji");
        const volumeLetterAControl = document.getElementById("volumeLetterA");
        const filterHiroControl = document.getElementById("filterHiro");
        const filterKanjiControl = document.getElementById("filterKanji");
        const filterLetterAControl = document.getElementById("filterLetterA");
        const loopHiroControl = document.getElementById("loopHiro");
        const loopKanjiControl = document.getElementById("loopKanji");
        const loopLetterAControl = document.getElementById("loopLetterA");
        const masterVolumeControl = document.getElementById("masterVolume");
        const masterSpeedControl = document.getElementById("masterSpeed");


        loopHiroControl.addEventListener('change', () => {
            console.log('Checked:', loopHiroControl.checked);
            audioHiro.loop = loopHiroControl.checked;
        });

        let hiroSource, kanjiSource, letterASource, gainNodeHiro, gainNodeKanji, gainNodeLetterA, filterHiro, filterKanji, filterLetterA;

        function setupAudioNodes() {
            if (isAudioSetup) return;

            masterGainNode = audioContext.createGain();

            hiroSource = audioContext.createMediaElementSource(audioHiro);
            kanjiSource = audioContext.createMediaElementSource(audioKanji);
            letterASource = audioContext.createMediaElementSource(audioLetterA);

            gainNodeHiro = audioContext.createGain();
            gainNodeKanji = audioContext.createGain();
            gainNodeLetterA = audioContext.createGain();

            filterHiro = audioContext.createBiquadFilter();
            filterHiro.type = "lowpass";
            filterHiro.frequency.value = 1000;

            filterKanji = audioContext.createBiquadFilter();
            filterKanji.type = "lowpass";
            filterKanji.frequency.value = 1000;

            filterLetterA = audioContext.createBiquadFilter();
            filterLetterA.type = "lowpass";
            filterLetterA.frequency.value = 1000;

            // Connect each source to its gain/filter, then to master gain, then to destination
            hiroSource.connect(filterHiro).connect(gainNodeHiro).connect(masterGainNode);
            kanjiSource.connect(filterKanji).connect(gainNodeKanji).connect(masterGainNode);
            letterASource.connect(filterLetterA).connect(gainNodeLetterA).connect(masterGainNode);
            masterGainNode.connect(audioContext.destination);

            isAudioSetup = true;
        }


        async function ensureAudioContextRunning() {
            if (audioContext.state === "suspended") {
                await audioContext.resume();
            }
        }

        async function playAudio(audioElement) {
            await ensureAudioContextRunning();
            setupAudioNodes();
            audioElement.play();
        }

        function applySpeed() {
            const speed = parseFloat(masterSpeedControl.value);
        }

        document.getElementById("markerHiro").addEventListener("markerFound", async () => {
            await playAudio(audioHiro);
            markerVisible = true;
            applySpeed(); // Apply speed for Hiro when the marker is found
        });

        document.getElementById("markerHiro").addEventListener("markerLost", () => {
            markerVisible = false;
        });

        document.getElementById("markerKanji").addEventListener("markerFound", async () => {
            await playAudio(audioKanji);
            applySpeed(); // Apply speed for Kanji when the marker is found
        });

        document.getElementById("markerLetterA").addEventListener("markerFound", async () => {
            await playAudio(audioLetterA);
            applySpeed(); // Apply speed for LetterA when the marker is found
        });

        volumeHiroControl.addEventListener("input", (e) => {
            if (gainNodeHiro) {
                gainNodeHiro.gain.value = e.target.value;
            }
        });

        volumeKanjiControl.addEventListener("input", (e) => {
            if (gainNodeKanji) {
                gainNodeKanji.gain.value = e.target.value;
            }
        });

        volumeLetterAControl.addEventListener("input", (e) => {
            if (gainNodeLetterA) {
                gainNodeLetterA.gain.value = e.target.value;
            }
        });

        filterHiroControl.addEventListener("input", (e) => {
            if (filterHiro) {
                filterHiro.frequency.value = e.target.value;
            }
        });

        filterKanjiControl.addEventListener("input", (e) => {
            if (filterKanji) {
                filterKanji.frequency.value = e.target.value;
            }
        });

        filterLetterAControl.addEventListener("input", (e) => {
            if (filterLetterA) {
                filterLetterA.frequency.value = e.target.value;
            }
        });

        masterVolumeControl.addEventListener("input", (e) => {
            if (masterGainNode) {
                masterGainNode.gain.value = e.target.value;
            }
        });

        masterSpeedControl.addEventListener("input", applySpeed);

        loopKanjiControl.addEventListener("change", () => {
            audioKanji.loop = loopKanjiControl.checked;
        });

        loopLetterAControl.addEventListener("change", () => {
            audioLetterA.loop = loopLetterAControl.checked;
        });



    </script>

    <script>

        let animationInterval;
        let currentCircle = 1;

        function startCircleAnimation() {
            if (animationInterval) return; // avoid starting twice

            animationInterval = setInterval(() => {
                const audioPlaying = !audioHiro.paused && !audioHiro.ended;
                const isLooping = loopHiroControl.checked;

                if ((audioPlaying || isLooping) && markerVisible) {
                    if (currentCircle === 1) {
                        circle1.classList.add('filled');
                        circle2.classList.remove('filled');
                        currentCircle = 2;
                    } else {
                        circle2.classList.add('filled');
                        circle1.classList.remove('filled');
                        currentCircle = 1;
                    }
                } else {
                    circle1.classList.remove('filled');
                    circle2.classList.remove('filled');
                }
            }, 1000); // toggle every 1 second
        }

        startCircleAnimation();

    </script>

</body>

</html>