<!DOCTYPE html>
<html>

<head>
    <title>Phone Shake to micro:bit</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            margin-top: 50px;
        }

        button {
            font-size: 20px;
            padding: 15px 30px;
            margin-top: 30px;
        }

        #status {
            margin-top: 20px;
            color: green;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h1>Shake to Send 🚀</h1>
    <button id="connect">Connect to micro:bit</button>
    <div id="status">Not connected</div>

    <script>
        let bluetoothDevice;
        let txCharacteristic;
        let lastShake = 0;

        const SHAKE_THRESHOLD = 15; // tweak if needed

        document.getElementById('connect').addEventListener('click', async () => {
            try {
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'BBC micro:bit' }],
                    optionalServices: ["6e400001-b5a3-f393-e0a9-e50e24dcca9e"]
                });

                const server = await bluetoothDevice.gatt.connect();
                const service = await server.getPrimaryService("6e400001-b5a3-f393-e0a9-e50e24dcca9e");
                txCharacteristic = await service.getCharacteristic("6e400002-b5a3-f393-e0a9-e50e24dcca9e");

                document.getElementById('status').textContent = 'Connected ✅';
            } catch (error) {
                console.error(error);
                document.getElementById('status').textContent = 'Connection failed ❌';
                alert('Error: ' + error);

            }
        });

        window.addEventListener('devicemotion', (event) => {
            if (!txCharacteristic) return;

            const acc = event.accelerationIncludingGravity;
            const total = Math.sqrt(acc.x * acc.x + acc.y * acc.y + acc.z * acc.z);
            const now = Date.now();

            if (total > SHAKE_THRESHOLD && (now - lastShake) > 2000) {
                lastShake = now;
                sendMessage("Anna's phone was shaken!");
            }
        });

        async function sendMessage(message) {
            const encoder = new TextEncoder();
            const data = encoder.encode(message);
            try {
                await txCharacteristic.writeValue(data);
                console.log("Sent:", message);
            } catch (e) {
                console.error("Send error:", e);
            }
        }
    </script>
</body>

</html>